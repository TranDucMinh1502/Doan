# ğŸ“š HÆ°á»›ng Dáº«n Chá»©c NÄƒng Gia Háº¡n SÃ¡ch (Renew Book)

## âœ… Chá»©c NÄƒng ÄÃ£ HoÃ n Thiá»‡n

### ğŸ”„ Gia Háº¡n SÃ¡ch (Renew Book)

Chá»©c nÄƒng cho phÃ©p member gia háº¡n thá»i gian mÆ°á»£n sÃ¡ch thÃªm 15 ngÃ y.

---

## ğŸ“‹ ThÃ´ng Tin CÆ¡ Báº£n

### Quy Ä‘á»‹nh gia háº¡n:

- âœ… **Sá»‘ láº§n gia háº¡n tá»‘i Ä‘a**: 2 láº§n
- âœ… **Thá»i gian má»—i láº§n gia háº¡n**: 15 ngÃ y
- âœ… **Äiá»u kiá»‡n**: Chá»‰ gia háº¡n Ä‘Æ°á»£c cho sÃ¡ch Ä‘ang mÆ°á»£n (status = "borrowed")
- âœ… **Tá»•ng thá»i gian tá»‘i Ä‘a**: 15 + 15 + 15 = 45 ngÃ y

### Ai cÃ³ thá»ƒ gia háº¡n?

- âœ… Member Ä‘ang mÆ°á»£n sÃ¡ch
- âœ… SÃ¡ch chÆ°a quÃ¡ háº¡n (hoáº·c Ä‘ang quÃ¡ háº¡n nhÆ°ng váº«n gia háº¡n Ä‘Æ°á»£c)
- âœ… CÃ²n lÆ°á»£t gia háº¡n (chÆ°a Ä‘áº¡t 2 láº§n)

---

## ğŸ¯ CÃ¡ch Sá»­ Dá»¥ng

### BÆ°á»›c 1: VÃ o mÃ n hÃ¬nh My Loans

1. Login vá»›i tÃ i khoáº£n Member
2. Click tab **"My Loans"** á»Ÿ Bottom Navigation
3. Xem danh sÃ¡ch sÃ¡ch Ä‘ang mÆ°á»£n

### BÆ°á»›c 2: Kiá»ƒm tra sá»‘ láº§n gia háº¡n

Má»—i sÃ¡ch hiá»ƒn thá»‹:

```
ğŸ“š TÃªn sÃ¡ch
ğŸ“… Issue Date: [NgÃ y mÆ°á»£n]
ğŸ“… Due Date: [Háº¡n tráº£]
ğŸ” Sá»‘ láº§n gia háº¡n: 0 / 2 (CÃ²n 2)
```

### BÆ°á»›c 3: Click nÃºt "Renew"

- NÃºt **"Renew"** (mÃ u xanh) náº±m bÃªn cáº¡nh nÃºt "Return"
- Náº¿u Ä‘Ã£ gia háº¡n 2 láº§n â†’ NÃºt bá»‹ áº©n
- Click Ä‘á»ƒ má»Ÿ dialog xÃ¡c nháº­n

### BÆ°á»›c 4: XÃ¡c nháº­n gia háº¡n

Dialog hiá»ƒn thá»‹:

```
ğŸ”„ Gia háº¡n sÃ¡ch

Báº¡n muá»‘n gia háº¡n thÃªm 15 ngÃ y?

ğŸ“… ThÃ´ng tin gia háº¡n:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“† Háº¡n tráº£ hiá»‡n táº¡i: 10 Th12 2025
âœ… Háº¡n tráº£ má»›i:     25 Th12 2025
ğŸ” Sá»‘ láº§n gia háº¡n Ä‘Ã£ dÃ¹ng: 0 / 2
â„¹ï¸  CÃ²n láº¡i sau khi gia háº¡n: 1 láº§n

âš ï¸ Báº¡n cÃ²n 1 láº§n gia háº¡n sau nÃ y.

[Há»§y]  [âœ“ XÃ¡c nháº­n gia háº¡n]
```

### BÆ°á»›c 5: Káº¿t quáº£

- âœ… **ThÃ nh cÃ´ng**: "Gia háº¡n thÃ nh cÃ´ng! Háº¡n má»›i: 25 Th12 2025"
- âœ… Due date Ä‘Æ°á»£c cáº­p nháº­t
- âœ… Renew count tÄƒng lÃªn (0 â†’ 1)
- âœ… UI cáº­p nháº­t ngay láº­p tá»©c

---

## ğŸ¨ Giao Diá»‡n

### Card sÃ¡ch trong My Loans:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š [áº¢nh]  TÃªn sÃ¡ch                     â”‚
â”‚           TÃ¡c giáº£                       â”‚
â”‚                                         â”‚
â”‚ ğŸ“… Issue Date: 01 Th12 2025            â”‚
â”‚ ğŸ“… Due Date:   15 Th12 2025            â”‚
â”‚ â±ï¸  14 days remaining                   â”‚
â”‚                                         â”‚
â”‚ ğŸ” Sá»‘ láº§n gia háº¡n: [0 / 2 (CÃ²n 2)]    â”‚ â† Badge mÃ u xanh
â”‚                                         â”‚
â”‚ [Return]  [Renew]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Badge sá»‘ láº§n gia háº¡n:

- **0 / 2 (CÃ²n 2)** â†’ Badge mÃ u xanh âœ…
- **1 / 2 (CÃ²n 1)** â†’ Badge mÃ u cam ğŸŸ§
- **2 / 2** â†’ Badge mÃ u Ä‘á» â›” (nÃºt Renew bá»‹ áº©n)

### Dialog xÃ¡c nháº­n:

- ğŸ”· **Header**: Icon update + "Gia háº¡n sÃ¡ch"
- ğŸ“Š **ThÃ´ng tin**: Box mÃ u xanh nháº¡t vá»›i chi tiáº¿t
- âš ï¸ **Warning**: Box mÃ u vÃ ng vá»›i lÆ°u Ã½
- âœ… **Actions**: NÃºt Há»§y + XÃ¡c nháº­n

---

## ğŸ”§ Technical Details

### Files liÃªn quan:

```
lib/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ loan_service.dart           # renewLoan() method
â””â”€â”€ screens/
    â””â”€â”€ member/
        â””â”€â”€ my_loans.dart           # UI + _handleRenew()
```

### Key Method: renewLoan()

**Location**: `lib/services/loan_service.dart`

```dart
Future<void> renewLoan(String loanId, {int additionalDays = 15}) async {
  // 1. Validate loan exists
  // 2. Check status = "borrowed"
  // 3. Check renewCount < 2
  // 4. Calculate new due date (current + 15 days)
  // 5. Update loan document:
  //    - dueDate: newDueDate
  //    - renewCount: renewCount + 1
}
```

**Parameters**:

- `loanId`: ID cá»§a loan cáº§n gia háº¡n
- `additionalDays`: Sá»‘ ngÃ y gia háº¡n (default = 15)

**Validation**:

- âŒ Loan khÃ´ng tá»“n táº¡i â†’ "Loan not found"
- âŒ Status != "borrowed" â†’ "Only active loans can be renewed"
- âŒ renewCount >= 2 â†’ "Maximum renewal limit (2) reached"
- âœ… Há»£p lá»‡ â†’ Update dueDate + renewCount

### UI Flow:

```
Member clicks "Renew"
       â†“
_handleRenew(loan)
       â†“
Check renewCount < 2
       â†“
Show confirmation dialog
   â”œâ”€ Current due date
   â”œâ”€ New due date (+15 days)
   â”œâ”€ Used renewals: X / 2
   â””â”€ Remaining renewals: Y
       â†“
User confirms
       â†“
loanService.renewLoan(loan.id)
       â†“
Update Firestore:
   - dueDate: +15 days
   - renewCount: +1
       â†“
Success message + Reload UI
```

---

## ğŸ“Š Scenarios

### Scenario 1: Gia háº¡n láº§n Ä‘áº§u (0/2)

```
Tráº¡ng thÃ¡i ban Ä‘áº§u:
- Issue Date: 01/12/2025
- Due Date:   15/12/2025
- Renew Count: 0 / 2

Member clicks "Renew" â†’ Confirms

Tráº¡ng thÃ¡i sau gia háº¡n:
- Due Date:   30/12/2025  â† +15 days
- Renew Count: 1 / 2      â† +1
- Message: "Gia háº¡n thÃ nh cÃ´ng! Háº¡n má»›i: 30 Th12 2025"
```

### Scenario 2: Gia háº¡n láº§n 2 (1/2)

```
Tráº¡ng thÃ¡i ban Ä‘áº§u:
- Due Date:   30/12/2025
- Renew Count: 1 / 2

Member clicks "Renew" â†’ Confirms

Tráº¡ng thÃ¡i sau gia háº¡n:
- Due Date:   14/01/2026  â† +15 days
- Renew Count: 2 / 2      â† +1
- Message: "Gia háº¡n thÃ nh cÃ´ng! Háº¡n má»›i: 14 Th1 2026"
- Warning: "ÄÃ¢y lÃ  láº§n gia háº¡n cuá»‘i cÃ¹ng cá»§a báº¡n."
- NÃºt "Renew" bá»‹ áº©n
```

### Scenario 3: ÄÃ£ háº¿t lÆ°á»£t gia háº¡n (2/2)

```
Tráº¡ng thÃ¡i:
- Renew Count: 2 / 2
- NÃºt "Renew" KHÃ”NG hiá»ƒn thá»‹

Member khÃ´ng thá»ƒ gia háº¡n thÃªm
â†’ Pháº£i tráº£ sÃ¡ch vÃ  mÆ°á»£n láº¡i (náº¿u cáº§n)
```

### Scenario 4: SÃ¡ch quÃ¡ háº¡n nhÆ°ng váº«n gia háº¡n Ä‘Æ°á»£c

```
Tráº¡ng thÃ¡i:
- Due Date: 01/12/2025 (quÃ¡ háº¡n 5 ngÃ y)
- Status: "overdue"
- Renew Count: 0 / 2

Member váº«n cÃ³ thá»ƒ gia háº¡n:
- Due Date má»›i: 16/12/2025 (tá»« ngÃ y hiá»‡n táº¡i +15)
- Renew Count: 1 / 2
```

---

## âš ï¸ LÆ°u Ã Quan Trá»ng

### 1. Giá»›i háº¡n gia háº¡n

- Má»—i loan chá»‰ Ä‘Æ°á»£c gia háº¡n **tá»‘i Ä‘a 2 láº§n**
- Má»—i láº§n gia háº¡n thÃªm **15 ngÃ y**
- KhÃ´ng thá»ƒ gia háº¡n sau khi Ä‘Ã£ tráº£ sÃ¡ch

### 2. TÃ­nh toÃ¡n due date

- Due date má»›i = Due date hiá»‡n táº¡i + 15 ngÃ y
- KHÃ”NG pháº£i tá»« ngÃ y hiá»‡n táº¡i
- VÃ­ dá»¥:
  - Current due: 15/12
  - Gia háº¡n ngÃ y: 10/12
  - New due: 30/12 (15/12 + 15)

### 3. SÃ¡ch quÃ¡ háº¡n

- Váº«n cÃ³ thá»ƒ gia háº¡n náº¿u cÃ²n lÆ°á»£t
- Fine (náº¿u cÃ³) váº«n Ä‘Æ°á»£c tÃ­nh
- Gia háº¡n khÃ´ng xÃ³a fine Ä‘Ã£ cÃ³

### 4. Firestore Rules

Cáº§n permission Ä‘á»ƒ update loan:

```javascript
allow update: if isSignedIn() &&
  (isOwner(resource.data.userId) || isLibrarian());
```

### 5. UI/UX

- NÃºt "Renew" chá»‰ hiá»‡n khi renewCount < 2
- Dialog hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ thÃ´ng tin
- Success message bao gá»“m due date má»›i
- Badge hiá»ƒn thá»‹ sá»‘ láº§n cÃ²n láº¡i

---

## ğŸ§ª Testing Checklist

### Test Case 1: Gia háº¡n láº§n Ä‘áº§u

- [ ] Login as Member
- [ ] CÃ³ sÃ¡ch Ä‘ang mÆ°á»£n (renewCount = 0)
- [ ] Click "Renew"
- [ ] Xem dialog vá»›i thÃ´ng tin Ä‘áº§y Ä‘á»§
- [ ] Confirm â†’ Success
- [ ] Due date +15 days
- [ ] Renew count: 0 â†’ 1
- [ ] Badge hiá»ƒn thá»‹ "1 / 2 (CÃ²n 1)"

### Test Case 2: Gia háº¡n láº§n 2

- [ ] SÃ¡ch Ä‘Ã£ gia háº¡n 1 láº§n (renewCount = 1)
- [ ] Click "Renew"
- [ ] Dialog warning: "ÄÃ¢y lÃ  láº§n gia háº¡n cuá»‘i cÃ¹ng"
- [ ] Confirm â†’ Success
- [ ] Renew count: 1 â†’ 2
- [ ] NÃºt "Renew" biáº¿n máº¥t
- [ ] Badge hiá»ƒn thá»‹ "2 / 2" (mÃ u Ä‘á»)

### Test Case 3: KhÃ´ng thá»ƒ gia háº¡n (Ä‘Ã£ háº¿t lÆ°á»£t)

- [ ] SÃ¡ch Ä‘Ã£ gia háº¡n 2 láº§n (renewCount = 2)
- [ ] NÃºt "Renew" KHÃ”NG hiá»ƒn thá»‹
- [ ] KhÃ´ng cÃ³ cÃ¡ch nÃ o gia háº¡n thÃªm

### Test Case 4: Gia háº¡n sÃ¡ch quÃ¡ háº¡n

- [ ] SÃ¡ch quÃ¡ háº¡n (overdue)
- [ ] Váº«n cÃ²n lÆ°á»£t gia háº¡n
- [ ] Click "Renew" â†’ ThÃ nh cÃ´ng
- [ ] Due date Ä‘Æ°á»£c cáº­p nháº­t
- [ ] Status váº«n lÃ  "overdue" (náº¿u váº«n quÃ¡ háº¡n)

### Test Case 5: Error handling

- [ ] Network error â†’ Show error message
- [ ] Permission denied â†’ "Vui lÃ²ng kiá»ƒm tra Firestore rules"
- [ ] Max limit â†’ "ÄÃ£ Ä‘áº¡t giá»›i háº¡n gia háº¡n tá»‘i Ä‘a"

---

## ğŸ¯ Káº¿t Luáº­n

### âœ… HoÃ n thiá»‡n:

1. âœ… Backend: `renewLoan()` method in LoanService
2. âœ… UI: NÃºt "Renew" trong My Loans
3. âœ… Dialog: XÃ¡c nháº­n vá»›i thÃ´ng tin Ä‘áº§y Ä‘á»§
4. âœ… Validation: Check renewCount, status
5. âœ… Display: Badge hiá»ƒn thá»‹ sá»‘ láº§n gia háº¡n
6. âœ… Messages: Success/error messages
7. âœ… Real-time: UI cáº­p nháº­t ngay sau gia háº¡n

### ğŸ“Š Thá»‘ng kÃª:

- **Sá»‘ láº§n gia háº¡n tá»‘i Ä‘a**: 2 láº§n
- **Thá»i gian má»—i láº§n**: 15 ngÃ y
- **Tá»•ng thá»i gian tá»‘i Ä‘a**: 45 ngÃ y (15 + 15 + 15)
- **UI elements**: 3 badges (green/orange/red)
- **Error cases**: 3 types handled

### ğŸš€ Sáºµn sÃ ng sá»­ dá»¥ng!

Chá»©c nÄƒng gia háº¡n sÃ¡ch Ä‘Ã£ hoÃ n thiá»‡n 100% vÃ  sáºµn sÃ ng Ä‘á»ƒ test! ğŸ‰
